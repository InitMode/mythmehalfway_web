<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Myth Me Halfway – Story Library</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #111;
    color: #fff;
}

header {
    background: #222;
    padding: 15px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
}

.controls {
    display: flex;
    gap: 10px;
    padding: 10px;
    background: #1a1a1a;
    position: sticky;
    top: 0;
    z-index: 20;
}

input, select {
    padding: 8px;
    border-radius: 6px;
    border: none;
}

#storiesContainer {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 15px;
}

.story-card {
    background: #222;
    padding: 15px;
    border-radius: 10px;
    cursor: pointer;
    border: 1px solid #333;
}

.story-card:hover {
    background: #333;
}

/* Modal */
#storyModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

#modalContent {
    background: #222;
    padding: 20px;
    max-width: 800px;
    width: 100%;
    border-radius: 12px;
    max-height: 90vh;
    overflow-y: auto;
}

#closeModal {
    float: right;
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
}
</style>
</head>

<body>

<header>
    Myth Me Halfway &middot; <span id="currentYear"></span>
</header>

<div class="controls">
    <input type="text" id="searchInput" placeholder="Search stories...">
    <select id="typeFilter">
        <option value="all">All Types</option>
    </select>
    <select id="sortFilter">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
    </select>
</div>

<div id="statusText">Loading stories…</div>
<div id="storyCount"></div>

<div id="storiesContainer"></div>

<!-- Modal -->
<div id="storyModal">
    <div id="modalContent">
        <span id="closeModal">✖</span>
        <h2 id="modalTitle"></h2>
        <div id="modalStoryContent"></div>
    </div>
</div>

<script>
document.getElementById("currentYear").textContent = new Date().getFullYear();

const BASE_PATH = window.location.pathname.replace(/\/$/, "");
const API_BASE = BASE_PATH + "/api";
const STORIES_INDEX = API_BASE + "/stories/index.json";

let allStories = [];
let displayedStories = [];

const storyContainer = document.getElementById("storiesContainer");
const statusText = document.getElementById("statusText");
const searchInput = document.getElementById("searchInput");
const sortFilter = document.getElementById("sortFilter");

const storyModal = document.getElementById("storyModal");
const closeModal = document.getElementById("closeModal");
const modalTitle = document.getElementById("modalTitle");
const modalStoryContent = document.getElementById("modalStoryContent");

async function fetchStories() {
    try {
        const res = await fetch(STORIES_INDEX + "?t=" + Date.now());
        if (!res.ok) throw new Error("Bad status " + res.status);
        return await res.json();
    } catch (err) {
        console.error("Failed to fetch stories:", err);
        return [];
    }
}

async function loadStories(initial = true) {
    const files = await fetchStories();
    const newStories = files.map(f => ({
        id: f.replace(".md", ""),
        filename: f,
        path: API_BASE + "/stories/" + f
    }));

    if (initial) {
        allStories = newStories;
        displayedStories = [...allStories];
        renderStories();
        statusText.textContent = "Stories loaded ✓";
    } else {
        // Detect newly added stories
        const existingIds = allStories.map(s => s.id);
        const added = newStories.filter(s => !existingIds.includes(s.id));
        if (added.length > 0) {
            allStories.push(...added);
            displayedStories = [...allStories];
            renderStories();
            statusText.textContent = "Stories updated ✓";
        }
    }
}

function renderStories() {
    storyContainer.innerHTML = "";
    displayedStories.forEach(story => {
        const div = document.createElement("div");
        div.className = "story-card";
        div.innerHTML = `<h3>${story.id}</h3><small>${story.filename}</small>`;
        div.onclick = () => openStory(story);
        storyContainer.appendChild(div);
    });
    document.getElementById("storyCount").textContent = displayedStories.length + " stories";
}

async function openStory(story) {
    modalTitle.textContent = story.id;
    modalStoryContent.innerHTML = "Loading…";
    storyModal.style.display = "flex";

    const res = await fetch(story.path);
    if (res.ok) {
        const text = await res.text();
        modalStoryContent.innerHTML = `<pre style="white-space: pre-wrap;">${text}</pre>`;
    } else {
        modalStoryContent.innerHTML = "Error loading file.";
    }
}

closeModal.onclick = () => storyModal.style.display = "none";

searchInput.oninput = applyFilters;
sortFilter.onchange = applyFilters;

function applyFilters() {
    const q = searchInput.value.toLowerCase();
    displayedStories = allStories.filter(s =>
        s.id.toLowerCase().includes(q) || s.filename.toLowerCase().includes(q)
    );
    if (sortFilter.value === "newest") displayedStories.reverse();
    renderStories();
}

// Initial load
loadStories();

// Auto-refresh / auto-detect new stories every 30 seconds
setInterval(() => loadStories(false), 30000);
</script>

</body>
</html>
