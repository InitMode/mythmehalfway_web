<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* [Keep all your existing CSS styles exactly as they are] */
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body.dark-mode {
            --primary-color: #6366f1;
            --secondary-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            padding-bottom: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            padding: 2rem 1rem;
            border-radius: 0 0 20px 20px;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .story-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .story-image {
            height: 200px;
            width: 100%;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .story-content {
            padding: 1.5rem;
        }

        .story-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            line-height: 1.4;
        }

        .story-author {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .story-description {
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .story-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .story-tag {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .story-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: #64748b;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            margin-top: auto;
        }

        .read-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .read-btn:hover {
            background: #4338ca;
            color: white;
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #4338ca;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            margin: 0 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .no-stories {
            text-align: center;
            padding: 3rem;
            color: #64748b;
            font-size: 1.1rem;
        }

        .category-filter {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: #64748b;
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-box {
                max-width: 100%;
                margin: 0;
            }
            
            .category-filter {
                margin-right: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header text-center">
            <h1 class="mb-3">üìö MythMeHalfway Stories</h1>
            <p class="mb-0">Discover amazing stories from our collection</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="theme-toggle" id="themeToggle">
                üåô Toggle Theme
            </button>
            
            <input 
                type="text" 
                class="search-box" 
                id="searchBox" 
                placeholder="Search stories by title, author, or tags..."
            >
            
            <select class="category-filter" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="fiction">Fiction</option>
                <option value="non-fiction">Non-Fiction</option>
                <option value="blog">Blog</option>
            </select>
            
            <button class="read-btn" id="refreshBtn">
                üîÑ Refresh
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading stories...</p>
        </div>

        <!-- Stories Grid -->
        <div id="storiesGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" style="display: none;">
            <!-- Stories will be inserted here by JavaScript -->
        </div>

        <!-- No Stories Message -->
        <div id="noStories" class="no-stories" style="display: none;">
            <p>No stories found. Try refreshing or check your connection.</p>
            <button class="read-btn mt-3" id="retryBtn">Retry Loading</button>
        </div>

        <!-- Demo Stories (hidden by default) -->
        <div id="demoStories" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" style="display: none;">
            <!-- Demo stories will be inserted here if API fails -->
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>¬© 2024 MythMeHalfway | Total Stories: <span id="storyCount">0</span></p>
            <p><small id="apiStatus">Loading stories...</small></p>
        </div>
    </div>

    <script>
        // Configuration - Using current path as base
        const CONFIG = {
            // Use relative paths from current location
            basePath: window.location.pathname.includes('/mythmehalfway_web/') 
                ? '/mythmehalfway_web/' 
                : '/',
            get statusEndpoint() {
                return this.basePath + 'api/status.json';
            },
            get storiesIndexEndpoint() {
                return this.basePath + 'api/stories/index.json';
            },
            get storiesPath() {
                return this.basePath + 'api/stories/';
            }
        };

        console.log('Base path:', CONFIG.basePath);
        console.log('Status endpoint:', CONFIG.statusEndpoint);

        // State
        let allStories = [];
        let filteredStories = [];

        // DOM Elements
        const storiesGrid = document.getElementById('storiesGrid');
        const demoStoriesGrid = document.getElementById('demoStories');
        const loadingElement = document.getElementById('loading');
        const noStoriesElement = document.getElementById('noStories');
        const storyCountElement = document.getElementById('storyCount');
        const apiStatusElement = document.getElementById('apiStatus');
        const searchBox = document.getElementById('searchBox');
        const categoryFilter = document.getElementById('categoryFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const retryBtn = document.getElementById('retryBtn');
        const themeToggle = document.getElementById('themeToggle');

        // Demo stories data (fallback)
        const DEMO_STORIES = [
            {
                id: 'demo1',
                title: "The Girl Who Borrowed the Wind",
                author: "Salt Merchant",
                category: "fiction",
                cover: "https://source.unsplash.com/featured/?baobab,wind",
                description: "A short magical tale from Ukambani about courage, sacrifice, and the Wind Spirit Mwenga Mkuu.",
                content: `# The Girl Who Borrowed the Wind

In the drought-stricken plains of Ukambani, there lived a young girl named Mumo.  
Her village had not felt a breeze in many moons, and the wells were turning into dust.

One evening, Mumo wandered to the sacred hill where the old stories say the **Wind Spirit**,  
_Mwenga Mkuu_, sleeps inside a giant baobab tree.  
Most children feared the place‚Äîbut Mumo was brave.

She placed her palms on the rough bark.

> "Great Mwenga," she whispered.  
> "My people grow weak. Please, wake, even for a moment."

The baobab groaned.  
A cool swirl of air wrapped around her wrists like bracelets of morning mist.

The Wind Spirit spoke:

> "Child of courage, I can lend you a breeze.  
> But when I give, something must be returned."

Mumo thought hard. She had no water.  
She had no cattle.  
But she had her voice.

So she offered it.

> "Take my songs, Mwenga.  
> My voice carries stories, and stories are part of the wind."

The spirit agreed.  
A powerful gust spiraled into her hands, glowing like soft blue fire.

Mumo ran home, releasing the wind across the dry fields.  
Clouds gathered, rain fell, children danced.

But Mumo could no longer sing.

Weeks later, the Wind Spirit returned, moved by her sacrifice.  
It placed a warm breeze in her throat.

> "Your songs are now part of every wind," it said.  
> "Each time the breeze touches your village, it brings your voice home."

And so the people of Ukambani say that when the wind hums through the baobab trees,  
you can hear a soft girl's song‚Äî  
a reminder of Mumo, who borrowed the wind to save her people.`,
                tags: ["African mythology", "Kenyan folklore", "magical realism"],
                readTime: 3
            },
            {
                id: 'demo2',
                title: "Digital Gardens",
                author: "Marcus Chen",
                category: "blog",
                cover: "https://source.unsplash.com/featured/?technology,garden",
                description: "Why tending to your personal notes is better than social media.",
                content: `# Digital Gardens

In the age of social media feeds, we've forgotten the joy of cultivation.  
A digital garden is not a polished portfolio or a chronological blog.  
It's a collection of evolving ideas, half-formed thoughts, and interconnected concepts.

Unlike social media, which demands instant perfection, a digital garden celebrates growth.  
Pages can be messy, incomplete, and interconnected.  
They grow organically, just like a real garden.

Start small. Plant a seed of an idea. Water it with regular updates.  
Watch it grow, branch out, and connect with other ideas in your garden.

Your digital garden is for you first, others second.  
It's a space for thinking in public, for showing your work, for embracing the process over the product.

In a world of consumption, be a creator.  
In a world of feeds, tend a garden.`,
                tags: ["technology", "blog", "personal growth"],
                readTime: 2
            },
            {
                id: 'demo3',
                title: "Echoes of History",
                author: "Sarah J. Miller",
                category: "non-fiction",
                cover: "https://source.unsplash.com/featured/?history,library",
                description: "Understanding the patterns of the past to predict the future.",
                content: `# Echoes of History

History doesn't repeat itself, but it often rhymes.  
The patterns we see in ancient civilizations echo through time to our modern world.

From the rise and fall of empires to economic cycles, human behavior follows predictable patterns.  
By studying these echoes, we can better understand our present and anticipate our future.

The key is not to look for exact repetitions, but for thematic parallels.  
How do societies respond to technological disruption?  
What happens when wealth becomes too concentrated?  
How do civilizations maintain stability in times of change?

These questions have been answered before, in different times and places.  
The answers are waiting in the echoes of history, if we're willing to listen.`,
                tags: ["history", "non-fiction", "analysis"],
                readTime: 4
            }
        ];

        // Parse markdown frontmatter
        function parseMarkdownFrontmatter(content) {
            const lines = content.split('\n');
            const frontmatter = {};
            let inFrontmatter = false;
            let contentStart = 0;
            
            if (lines[0] === '---') {
                inFrontmatter = true;
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i] === '---') {
                        inFrontmatter = false;
                        contentStart = i + 1;
                        break;
                    }
                    const match = lines[i].match(/^(\w+):\s*(.+)$/);
                    if (match) {
                        const [, key, value] = match;
                        frontmatter[key.trim()] = value.trim().replace(/^["']|["']$/g, '');
                    }
                }
            }
            
            const storyContent = lines.slice(contentStart).join('\n').trim();
            return { frontmatter, content: storyContent };
        }

        // Check if API is available
        async function checkAPIStatus() {
            try {
                console.log('Checking API at:', CONFIG.statusEndpoint);
                const response = await fetch(CONFIG.statusEndpoint, {
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    apiStatusElement.textContent = `API Status: ${data.status}`;
                    return true;
                } else {
                    console.log('API responded but not OK:', response.status);
                    apiStatusElement.textContent = `API Status: Error (${response.status})`;
                    return false;
                }
            } catch (error) {
                console.log('API check failed:', error);
                apiStatusElement.textContent = 'API Status: Not available (using demo stories)';
                return false;
            }
        }

        // Get list of story files from API
        async function getStoryFiles() {
            try {
                console.log('Fetching story index from:', CONFIG.storiesIndexEndpoint);
                const response = await fetch(CONFIG.storiesIndexEndpoint, {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    console.log('Story index fetch failed:', response.status);
                    throw new Error('Failed to fetch story index');
                }
                
                const files = await response.json();
                console.log('Found story files:', files);
                return Array.isArray(files) ? files : [];
            } catch (error) {
                console.error('Error fetching story index:', error);
                return [];
            }
        }

        // Fetch a single story from the API
        async function fetchStory(filename) {
            try {
                const storyUrl = CONFIG.storiesPath + filename;
                console.log('Fetching story:', storyUrl);
                
                const response = await fetch(storyUrl, {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    console.warn(`Failed to fetch ${filename}: ${response.status}`);
                    return null;
                }
                
                const markdown = await response.text();
                const { frontmatter, content } = parseMarkdownFrontmatter(markdown);
                
                return {
                    id: filename.replace('.md', ''),
                    filename: filename,
                    title: frontmatter.title || filename.replace('.md', '').replace('story', 'Story '),
                    author: frontmatter.author || 'Unknown Author',
                    category: (frontmatter.type || 'fiction').toLowerCase(),
                    cover: frontmatter.cover || `https://source.unsplash.com/featured/?story,${frontmatter.tags?.[0] || 'book'}`,
                    description: frontmatter.description || 'A captivating story waiting to be read...',
                    content: content,
                    tags: frontmatter.tags ? 
                        (Array.isArray(frontmatter.tags) ? 
                            frontmatter.tags : 
                            frontmatter.tags.split(',').map(tag => tag.trim())
                        ) : [],
                    readTime: Math.max(1, Math.ceil(content.split(/\s+/).length / 200))
                };
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return null;
            }
        }

        // Fetch all stories from API
        async function fetchAllStories() {
            loadingElement.style.display = 'block';
            storiesGrid.style.display = 'none';
            demoStoriesGrid.style.display = 'none';
            noStoriesElement.style.display = 'none';
            apiStatusElement.textContent = 'Loading...';
            
            try {
                // Check if API is running
                const isApiRunning = await checkAPIStatus();
                
                if (isApiRunning) {
                    // Get list of story files
                    const storyFiles = await getStoryFiles();
                    
                    if (storyFiles && storyFiles.length > 0) {
                        // Fetch each story
                        const storiesPromises = storyFiles.map(filename => fetchStory(filename));
                        const stories = (await Promise.all(storiesPromises)).filter(story => story !== null);
                        
                        if (stories.length > 0) {
                            allStories = stories;
                            filteredStories = [...stories];
                            updateStoryDisplay();
                            apiStatusElement.textContent = `Loaded ${stories.length} stories from API`;
                            return;
                        }
                    }
                }
                
                // If API fails or returns no stories, use demo stories
                console.log('Using demo stories');
                useDemoStories();
                
            } catch (error) {
                console.error('Error fetching stories:', error);
                useDemoStories();
            }
        }

        // Use demo stories as fallback
        function useDemoStories() {
            allStories = DEMO_STORIES;
            filteredStories = [...DEMO_STORIES];
            
            loadingElement.style.display = 'none';
            storiesGrid.style.display = 'none';
            demoStoriesGrid.innerHTML = filteredStories.map(createStoryCard).join('');
            demoStoriesGrid.style.display = 'flex';
            storyCountElement.textContent = filteredStories.length;
            
            apiStatusElement.textContent = 'Using demo stories (API not available)';
        }

        // Create story card HTML
        function createStoryCard(story) {
            return `
                <div class="col">
                    <div class="story-card">
                        <img src="${story.cover}" alt="${story.title}" class="story-image" 
                             onerror="this.src='https://source.unsplash.com/featured/?${story.category},book'">
                        <div class="story-content d-flex flex-column">
                            <h3 class="story-title">${story.title}</h3>
                            <div class="story-author">By ${story.author}</div>
                            
                            <p class="story-description">${story.description}</p>
                            
                            ${story.tags && story.tags.length > 0 ? `
                                <div class="story-tags">
                                    ${story.tags.slice(0, 3).map(tag => `
                                        <span class="story-tag">${tag}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="story-meta mt-auto">
                                <span>üìñ ${story.readTime} min read</span>
                                <span class="text-capitalize">${story.category}</span>
                            </div>
                            
                            <button class="read-btn mt-3" onclick="readStory('${story.id}')">
                                Read Story
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update the stories display
        function updateStoryDisplay() {
            loadingElement.style.display = 'none';
            demoStoriesGrid.style.display = 'none';
            
            if (filteredStories.length === 0) {
                showNoStories('No stories match your search criteria.');
                return;
            }
            
            storiesGrid.innerHTML = filteredStories.map(createStoryCard).join('');
            storiesGrid.style.display = 'flex';
            storyCountElement.textContent = filteredStories.length;
        }

        // Show no stories message
        function showNoStories(message = 'No stories found.') {
            storiesGrid.style.display = 'none';
            demoStoriesGrid.style.display = 'none';
            loadingElement.style.display = 'none';
            noStoriesElement.innerHTML = `
                <p>${message}</p>
                <button class="read-btn mt-3" id="retryBtn">Retry Loading</button>
            `;
            noStoriesElement.style.display = 'block';
            storyCountElement.textContent = '0';
            
            // Re-attach event listener to retry button
            setTimeout(() => {
                document.getElementById('retryBtn').addEventListener('click', fetchAllStories);
            }, 100);
        }

        // Filter stories based on search and category
        function filterStories() {
            const searchTerm = searchBox.value.toLowerCase();
            const selectedCategory = categoryFilter.value.toLowerCase();
            
            filteredStories = allStories.filter(story => {
                const matchesSearch = !searchTerm || 
                    story.title.toLowerCase().includes(searchTerm) ||
                    story.author.toLowerCase().includes(searchTerm) ||
                    story.description.toLowerCase().includes(searchTerm) ||
                    (story.tags && story.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                
                const matchesCategory = !selectedCategory || 
                    story.category.toLowerCase() === selectedCategory;
                
                return matchesSearch && matchesCategory;
            });
            
            // Check if we're showing demo stories or API stories
            if (demoStoriesGrid.style.display === 'flex') {
                demoStoriesGrid.innerHTML = filteredStories.map(createStoryCard).join('');
                demoStoriesGrid.style.display = filteredStories.length > 0 ? 'flex' : 'none';
                storiesGrid.style.display = 'none';
            } else {
                updateStoryDisplay();
            }
            
            storyCountElement.textContent = filteredStories.length;
        }

        // Read story function
        function readStory(storyId) {
            const story = allStories.find(s => s.id === storyId);
            if (story) {
                // Create a modal to display the story
                const modalHTML = `
                    <div class="modal fade" id="storyModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${story.title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="text-center mb-4">
                                        <img src="${story.cover}" alt="${story.title}" 
                                             class="img-fluid rounded" style="max-height: 300px;"
                                             onerror="this.src='https://source.unsplash.com/featured/?book,story'">
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="text-muted">By ${story.author}</span>
                                        <span class="text-muted">${story.readTime} min read ‚Ä¢ <span class="text-capitalize">${story.category}</span></span>
                                    </div>
                                    <hr>
                                    <div class="story-content" style="line-height: 1.8; font-size: 1.1rem; white-space: pre-line;">
                                        ${story.content}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to body
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('storyModal'));
                modal.show();
                
                // Remove modal from DOM after hiding
                document.getElementById('storyModal').addEventListener('hidden.bs.modal', function() {
                    modalContainer.remove();
                });
            }
            return false;
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Initialize
        function init() {
            // Load theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è Light Mode';
            }

            // Event listeners
            searchBox.addEventListener('input', filterStories);
            categoryFilter.addEventListener('change', filterStories);
            refreshBtn.addEventListener('click', fetchAllStories);
            retryBtn.addEventListener('click', fetchAllStories);
            themeToggle.addEventListener('click', toggleTheme);

            // Load stories
            fetchAllStories();
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
