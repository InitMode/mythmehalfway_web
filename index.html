<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MythMeHalfway</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide-react"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        
        /* Custom styles for dark mode content rendering */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 700;
        }
        .markdown-content h1 { font-size: 1.875rem; }
        .markdown-content h2 { font-size: 1.5rem; }
        .markdown-content h3 { font-size: 1.25rem; }
        .markdown-content p, .markdown-content ul, .markdown-content ol, .markdown-content blockquote {
            margin-bottom: 1em;
            line-height: 1.75;
        }
        .markdown-content ul, .markdown-content ol { padding-left: 20px; }
        .markdown-content ul > li { list-style: disc; }
        .markdown-content ol > li { list-style: decimal; }
        .markdown-content blockquote {
            border-left: 4px solid #4f46e5;
            padding-left: 1rem;
            margin-left: 0;
            color: #4b5563; /* text-gray-600 */
            font-style: italic;
            background-color: #f3f4f6; /* bg-gray-50 */
            padding: 0.5rem 1rem;
            border-radius: 0 8px 8px 0;
        }
        .markdown-content.dark blockquote {
            border-left-color: #818cf8; /* indigo-400 */
            color: #9ca3af; /* text-gray-400 */
            background-color: #374151; /* bg-gray-700 */
        }
        .markdown-content a { color: #4f46e5; text-decoration: underline; }
        .markdown-content.dark a { color: #a5b4fc; }
        .markdown-content strong { font-weight: 700; }
        .markdown-content em { font-style: italic; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Import React hooks (they're available globally from CDN)
        const { useState, useEffect, useRef, useMemo } = React;

        // Helper to check if Lucide is available globally
        const Lucide = window['lucide-react'];
        const Icon = Lucide ? Lucide.Icon : null;
        
        // Custom component to handle missing Lucide
        const IconPlaceholder = ({ name, size = 20, color = "currentColor", className = "" }) => {
            if (Icon && Lucide[name]) {
                const SpecificIcon = Lucide[name];
                // Use React.createElement for lucide icons if available
                return React.createElement(SpecificIcon, { size, color, className });
            }
            // Fallback placeholder if lucide-react failed to load
            return React.createElement('span', {
                className: `inline-block w-5 h-5 align-middle text-center leading-5 ${className}`,
                style: { fontSize: size + 'px', color }
            }, 'â˜…');
        };

        // --- Configuration ---
        const GITHUB_API_CONFIG = {
            // API endpoints (using GitHub Pages API)
            apiBaseUrl: '', // Leave empty for same-origin requests (GitHub Pages)
            // CORRECTED: Assuming your API paths are relative to the root with an explicit /api/
            statusEndpoint: '/api/status.json',
            storiesIndexEndpoint: '/api/stories/index.json', 
        };

        // --- Sounds ---
        const SOUNDS = [
            { id: 'rain', name: 'Heavy Rain', url: 'https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg' },
            { id: 'fire', name: 'Campfire', url: 'https://actions.google.com/sounds/v1/ambiences/fire.ogg' },
            { id: 'coffee', name: 'Coffee Shop', url: 'https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg' },
            { id: 'forest', name: 'Forest', url: 'https://actions.google.com/sounds/v1/nature/forest_wind.ogg' }
        ];

        // --- Helper Functions ---
        const parseMarkdownFrontmatter = (content) => {
            const lines = content.split('\n');
            const frontmatter = {};
            let inFrontmatter = false;
            let contentStart = 0;

            if (lines[0] === '---') {
                inFrontmatter = true;
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i] === '---') {
                        inFrontmatter = false;
                        contentStart = i + 1;
                        break;
                    }
                    const match = lines[i].match(/^(\w+):\s*(.+)$/);
                    if (match) {
                        const [, key, value] = match;
                        frontmatter[key.trim()] = value.trim().replace(/^["']|["']$/g, '');
                    }
                }
            }

            const storyContent = lines.slice(contentStart).join('\n').trim();
            return { frontmatter, content: storyContent };
        };

        const estimateReadTime = (text) => {
            const wordsPerMinute = 200;
            const wordCount = text.split(/\s+/).length;
            return Math.max(1, Math.ceil(wordCount / wordsPerMinute));
        };

        // Simple Markdown to HTML converter (for display purposes)
        const convertMarkdownToHtml = (markdown, isDark) => {
            // Simplified conversion (not a full parser)
            let html = markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/gim, '<em>$1</em>') // Italic
                .replace(/^(>.*)$/gim, '<blockquote>$1</blockquote>'); // Blockquotes
                
            // Handle lists and paragraphs (very basic)
            html = html.split('\n\n').map(p => {
                if (p.startsWith('<h1>') || p.startsWith('<h2>') || p.startsWith('<h3>') || p.startsWith('<blockquote>')) {
                    return p;
                }
                if (p.startsWith('* ') || p.startsWith('- ')) {
                    return '<ul>' + p.split('\n').map(li => `<li>${li.substring(2).trim()}</li>`).join('') + '</ul>';
                }
                return `<p>${p.trim()}</p>`;
            }).join('');
            
            // Clean up blockquote content
            html = html.replace(/<blockquote>\s*>\s*(.*?)\s*<\/blockquote>/gim, '<blockquote>$1</blockquote>');
            
            return React.createElement('div', {
                className: `markdown-content text-base leading-relaxed ${isDark ? 'text-gray-200 dark' : 'text-gray-700'}`,
                dangerouslySetInnerHTML: { __html: html }
            });
        };


        // --- Data Fetching Functions ---
        const fetchStoriesFromAPI = async () => {
            try {
                // First check if API is running
                const statusResponse = await fetch(`${GITHUB_API_CONFIG.apiBaseUrl}${GITHUB_API_CONFIG.statusEndpoint}`);
                if (!statusResponse.ok) throw new Error('API not available');

                // Fetch stories index
                const storiesResponse = await fetch(`${GITHUB_API_CONFIG.apiBaseUrl}${GITHUB_API_CONFIG.storiesIndexEndpoint}`);
                if (!storiesResponse.ok) throw new Error('Failed to fetch stories index');

                const storiesIndex = await storiesResponse.json();

                // Load each story
                const storiesPromises = storiesIndex.map(async (storyFile) => {
                    try {
                        // FIX APPLIED: Corrected API path for individual story files
                        const storyResponse = await fetch(`${GITHUB_API_CONFIG.apiBaseUrl}/api/stories/${storyFile}`);
                        if (!storyResponse.ok) throw new Error(`Failed to fetch ${storyFile}`);

                        const markdown = await storyResponse.text();
                        const { frontmatter, content } = parseMarkdownFrontmatter(markdown);

                        return {
                            id: storyFile.replace('.md', '').replace('story', ''),
                            title: frontmatter.title || 'Untitled Story',
                            author: frontmatter.author || 'Unknown Author',
                            category: frontmatter.type?.charAt(0).toUpperCase() + frontmatter.type?.slice(1) || 'Fiction',
                            cover: frontmatter.cover || `https://source.unsplash.com/featured/?story,${frontmatter.tags?.[0] || 'africa'}`,
                            description: frontmatter.description || 'A captivating story from the collection.',
                            content: content,
                            readTimeMin: estimateReadTime(content),
                            likes: Math.floor(Math.random() * 200) + 50,
                            views: Math.floor(Math.random() * 1000) + 100,
                            tags: frontmatter.tags ? frontmatter.tags.split(',').map(tag => tag.trim()) : []
                        };
                    } catch (error) {
                        console.error(`Error loading story ${storyFile}:`, error);
                        return null;
                    }
                });

                const stories = (await Promise.all(storiesPromises)).filter(story => story !== null);
                return stories;

            } catch (error) {
                console.error('Error fetching from API:', error);
                throw error;
            }
        };

        // Fallback to initial dummy data
        const getFallbackStories = () => {
            const generateDummyContent = (title) => {
                const paragraphs = [
                    `The sun hung low over the horizon, casting long shadows across the ${title.toLowerCase()}. It was a time of great change, whispered the elders, though the youth paid them no mind.`,
                    "Silence wrapped around the room like a heavy blanket. In the distance, a clock chimed, marking the passage of hours that felt like mere seconds.",
                    "Why do we seek the halfway point? It is neither here nor there, a purgatory of indecision. Yet, in this story, the middle ground is where the magic happens.",
                    "She turned the page, her fingers trembling slightly. The ink seemed to shimmer, rearranging itself into words that were meant only for her eyes.",
                    "The journey was far from over. Mountains loomed ahead, their peaks piercing the clouds, promising both danger and salvation to those brave enough to climb.",
                    "Technology hummed in the background, a constant reminder of the world they had left behind. But here, in the quiet, analog thoughts reigned supreme.",
                    "It wasn't just about the destination. It was about the people met along the way, the scars earned, and the stories that would be told for generations."
                ];
                return [...paragraphs, ...paragraphs, ...paragraphs].join('\n\n');
            };

            return [
                {
                    id: '1',
                    title: "The Girl Who Borrowed the Wind",
                    author: "Salt Merchant",
                    category: "Fiction",
                    cover: "https://source.unsplash.com/featured/?baobab,wind",
                    description: "A short magical tale from Ukambani about courage, sacrifice, and the Wind Spirit Mwenga Mkuu.",
                    content: `# The Girl Who Borrowed the Wind

In the drought-stricken plains of Ukambani, there lived a young girl named Mumo.
Her village had not felt a breeze in many moons, and the wells were turning into dust.

One evening, Mumo wandered to the sacred hill where the old stories say the **Wind Spirit**,
_Mwenga Mkuu_, sleeps inside a giant baobab tree.
Most children feared the placeâ€”but Mumo was brave.

She placed her palms on the rough bark.

> "Great Mwenga," she whispered.
> "My people grow weak. Please, wake, even for a moment."

The baobab groaned.
A cool swirl of air wrapped around her wrists like bracelets of morning mist.

The Wind Spirit spoke:

> "Child of courage, I can lend you a breeze.
> But when I give, something must be returned."

Mumo thought hard. She had no water.
She had no cattle.
But she had her voice.

So she offered it.

> "Take my songs, Mwenga.
> My voice carries stories, and stories are part of the wind."

The spirit agreed.
A powerful gust spiraled into her hands, glowing like soft blue fire.

Mumo ran home, releasing the wind across the dry fields.
Clouds gathered, rain fell, children danced.

But Mumo could no longer sing.

Weeks later, the Wind Spirit returned, moved by her sacrifice.
It placed a warm breeze in her throat.

> "Your songs are now part of every wind," it said.
> "Each time the breeze touches your village, it brings your voice home."

And so the people of Ukambani say that when the wind hums through the baobab trees,
you can hear a soft girl's songâ€”
a reminder of Mumo, who borrowed the wind to save her people.`,
                    readTimeMin: 3,
                    likes: 124,
                    views: 1050,
                    tags: ["African mythology", "Kenyan folklore", "magical realism", "short story"]
                },
                {
                    id: '2',
                    title: "Digital Gardens",
                    author: "Marcus Chen",
                    category: "Blog",
                    cover: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&q=80&w=600",
                    description: "Why tending to your personal notes is better than social media.",
                    content: generateDummyContent("Digital Gardens"),
                    readTimeMin: 3,
                    likes: 89,
                    views: 520,
                    tags: ["technology", "blog", "personal growth"]
                },
                {
                    id: '3',
                    title: "Echoes of History",
                    author: "Sarah J. Miller",
                    category: "Non-Fiction",
                    cover: "https://images.unsplash.com/photo-1461360370896-922624d12aa1?auto=format&fit=crop&q=80&w=600",
                    description: "Understanding the patterns of the past to predict the future.",
                    content: generateDummyContent("Echoes of History"),
                    readTimeMin: 8,
                    likes: 450,
                    views: 2300,
                    tags: ["history", "non-fiction", "analysis"]
                },
                {
                    id: '4',
                    title: "Neon Nights",
                    author: "J.D. Salinger-Bot",
                    category: "Fiction",
                    cover: "https://images.unsplash.com/photo-1555680202-c86f0e12f086?auto=format&fit=crop&q=80&w=600",
                    description: "Cyberpunk detective stories from a city that never sleeps.",
                    content: generateDummyContent("Neon Nights"),
                    readTimeMin: 6,
                    likes: 210,
                    views: 890,
                    tags: ["cyberpunk", "fiction", "detective"]
                }
            ];
        };

        // --- Sub-Components ---

        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            return React.createElement('div', {
                className: `fixed top-20 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-[100] animate-fade-in flex items-center gap-2`
            },
                React.createElement('span', null, message),
                React.createElement('button', {
                    onClick: onClose,
                    className: "ml-2 hover:text-gray-200"
                }, 'âœ•')
            );
        };

        const Modal = ({ isOpen, onClose, title, children, isDark }) => {
            if (!isOpen) return null;

            return React.createElement('div', {
                className: "fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4"
            },
                React.createElement('div', {
                    className: `${isDark ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'} rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fade-in`
                },
                    React.createElement('div', {
                        className: `flex justify-between items-center p-6 border-b ${isDark ? 'border-gray-700 bg-gray-800' : 'border-gray-100 bg-white'} sticky top-0`
                    },
                        React.createElement('h2', { className: "text-xl font-bold" }, title),
                        React.createElement('button', {
                            onClick: onClose,
                            className: `p-2 rounded-full transition ${isDark ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`
                        }, 'âœ•')
                    ),
                    React.createElement('div', { className: "p-6" }, children)
                )
            );
        };

        // NEW COMPONENT: ReaderModal
        const ReaderModal = ({ book, onClose, isDark, onUpdateProgress, lastReadPosition }) => {
            const readerRef = useRef(null);
            
            useEffect(() => {
                const readerElement = readerRef.current;
                if (!readerElement || !book) return;

                const savedPosition = lastReadPosition?.position || 0;
                readerElement.scrollTop = savedPosition;

                const handleScroll = () => {
                    const scrollPosition = readerElement.scrollTop;
                    const maxScroll = readerElement.scrollHeight - readerElement.clientHeight;
                    const progress = maxScroll > 0 ? (scrollPosition / maxScroll) * 100 : 0;
                    
                    if (onUpdateProgress) {
                        onUpdateProgress(book.id, progress, scrollPosition);
                    }
                };

                readerElement.addEventListener('scroll', handleScroll);
                return () => readerElement.removeEventListener('scroll', handleScroll);
            }, [book, onUpdateProgress, lastReadPosition]);

            if (!book) return null;

            return React.createElement(Modal, {
                isOpen: true,
                onClose: onClose,
                title: book.title,
                isDark: isDark
            },
                React.createElement('div', {
                    ref: readerRef,
                    className: `p-4 h-[70vh] overflow-y-auto no-scrollbar rounded-lg ${isDark ? 'bg-gray-900' : 'bg-white'}`
                },
                    React.createElement('h1', { className: `text-3xl font-extrabold mb-2 ${isDark ? 'text-white' : 'text-gray-900'}` }, book.title),
                    React.createElement('p', { className: `text-sm font-medium mb-8 ${isDark ? 'text-indigo-400' : 'text-indigo-600'}` }, `By ${book.author} (${book.readTimeMin} min read)`),
                    
                    convertMarkdownToHtml(book.content, isDark),

                    React.createElement('div', { className: "mt-12 pt-4 border-t border-dashed border-gray-300" },
                        React.createElement('p', { className: `text-center text-sm ${isDark ? 'text-gray-500' : 'text-gray-400'}` }, '--- End of Story ---')
                    )
                )
            );
        };
        // END NEW COMPONENT: ReaderModal
        
        const BookCard = ({ book, onRead, isBookmarked, onToggleBookmark, onLike, likes, isDark }) => {
            return React.createElement('div', {
                className: `${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group border flex flex-col h-full animate-fade-in`
            },
                React.createElement('div', {
                    className: "relative h-48 overflow-hidden cursor-pointer",
                    onClick: () => onRead(book)
                },
                    React.createElement('img', {
                        src: book.cover,
                        alt: book.title,
                        className: "w-full h-full object-cover transition transform group-hover:scale-105 duration-500"
                    }),
                    React.createElement('div', { className: "absolute top-3 right-3 flex gap-2" },
                        React.createElement('button', {
                            onClick: (e) => { e.stopPropagation(); onToggleBookmark(book.id); },
                            className: `p-2 rounded-full backdrop-blur-md transition shadow-sm ${
                                isBookmarked
                                ? 'bg-yellow-400 text-white'
                                : 'bg-white/90 text-gray-600 hover:bg-white'
                            }`
                        }, 'ðŸ”–')
                    ),
                    React.createElement('div', { className: "absolute bottom-3 left-3" },
                        React.createElement('span', {
                            className: "px-2 py-1 text-xs font-semibold bg-black/70 text-white rounded-md backdrop-blur-sm"
                        }, book.category)
                    )
                ),
                React.createElement('div', { className: "p-5 flex-1 flex flex-col" },
                    React.createElement('h3', {
                        className: `font-bold text-lg leading-tight mb-1 cursor-pointer hover:text-indigo-500 transition ${isDark ? 'text-white' : 'text-gray-800'}`,
                        onClick: () => onRead(book)
                    }, book.title),
                    React.createElement('p', {
                        className: `text-sm mb-4 ${isDark ? 'text-gray-400' : 'text-gray-500'}`
                    }, `by ${book.author}`),
                    React.createElement('p', {
                        className: `text-sm line-clamp-2 mb-4 flex-1 ${isDark ? 'text-gray-300' : 'text-gray-600'}`
                    }, book.description),
                    React.createElement('div', {
                        className: `flex items-center justify-between mt-auto pt-4 border-t ${isDark ? 'border-gray-700' : 'border-gray-50'}`
                    },
                        React.createElement('div', {
                            className: `flex items-center gap-4 text-xs ${isDark ? 'text-gray-400' : 'text-gray-500'}`
                        },
                            React.createElement('span', { className: "flex items-center gap-1" }, 'â±ï¸ ', book.readTimeMin, ' min'),
                            React.createElement('button', {
                                onClick: (e) => {e.stopPropagation(); onLike(book.id)},
                                className: "flex items-center gap-1 hover:text-red-500 transition"
                            },
                                'â¤ï¸ ',
                                likes[book.id] || book.likes
                            )
                        ),
                        React.createElement('button', {
                            onClick: () => onRead(book),
                            className: "px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition shadow-md hover:shadow-lg"
                        }, 'Read')
                    )
                )
            );
        };

        const SoundWidget = ({ activeSound, onToggleSound, isDark }) => {
            const [isOpen, setIsOpen] = useState(false);
            const audioRef = useRef(null);

            useEffect(() => {
                if (activeSound) {
                    if (audioRef.current) {
                        audioRef.current.src = activeSound.url;
                        audioRef.current.play().catch(e => console.log("Audio play failed:", e));
                    }
                } else {
                    if (audioRef.current) {
                        audioRef.current.pause();
                        audioRef.current.src = "";
                    }
                }
            }, [activeSound]);

            return React.createElement('div', { className: "fixed bottom-24 right-6 z-50 flex flex-col items-end gap-2" },
                React.createElement('audio', { ref: audioRef, loop: true }),

                isOpen && React.createElement('div', {
                    className: `mb-2 p-2 rounded-lg shadow-xl border ${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} animate-fade-in flex flex-col gap-1 w-48`
                },
                    React.createElement('div', {
                        className: `text-xs font-bold uppercase tracking-wider px-2 py-1 ${isDark ? 'text-gray-400' : 'text-gray-500'}`
                    }, 'Background Sounds'),
                    SOUNDS.map(sound =>
                        React.createElement('button', {
                            key: sound.id,
                            onClick: () => onToggleSound(sound),
                            className: `w-full text-left px-3 py-2 rounded-md text-sm transition flex items-center justify-between
                                ${activeSound?.id === sound.id
                                    ? 'bg-indigo-100 text-indigo-700 font-semibold'
                                    : isDark ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-50'
                                }`
                        },
                            React.createElement('span', null, sound.name),
                            activeSound?.id === sound.id && 'ðŸ”Š'
                        )
                    ),
                    activeSound && React.createElement('button', {
                        onClick: () => onToggleSound(null),
                        className: "text-xs text-red-500 hover:text-red-600 mt-2 px-2 py-1 text-right w-full font-medium"
                    }, 'Stop Audio')
                ),
                React.createElement('button', {
                    onClick: () => setIsOpen(!isOpen),
                    className: `p-4 rounded-full shadow-lg transition transform hover:scale-105 ${
                        activeSound
                        ? 'bg-indigo-600 text-white ring-4 ring-indigo-200'
                        : isDark ? 'bg-gray-800 text-indigo-400 border border-gray-700' : 'bg-white text-indigo-600 border border-gray-200'
                    }`,
                    title: "Background Sounds"
                }, activeSound ? 'â¸ï¸' : 'ðŸŽµ')
            );
        };

        const ContinueReadingCard = ({ book, progress, onResume, isDark }) => {
            return React.createElement('div', {
                className: `mb-8 p-4 rounded-xl border-l-4 border-indigo-500 shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center ${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`
            },
                React.createElement('div', { className: "flex items-center gap-4 flex-1 w-full sm:w-auto mb-3 sm:mb-0" },
                    'ðŸ”„',
                    React.createElement('div', null,
                        React.createElement('h3', {
                            className: `font-semibold text-lg ${isDark ? 'text-white' : 'text-gray-800'}`
                        }, 'Continue Reading'),
                        React.createElement('p', {
                            className: `text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}`
                        }, `${book.title} by ${book.author}`)
                    )
                ),
                React.createElement('div', { className: "flex items-center gap-4 w-full sm:w-auto" },
                    React.createElement('div', { className: "w-28 h-2 bg-gray-300/50 rounded-full overflow-hidden" },
                        React.createElement('div', {
                            className: "h-full bg-indigo-500",
                            style: { width: `${progress}%` }
                        })
                    ),
                    React.createElement('span', {
                        className: `text-sm font-medium ${isDark ? 'text-indigo-300' : 'text-indigo-600'}`
                    }, `${Math.floor(progress)}%`),
                    React.createElement('button', {
                        onClick: onResume,
                        className: "flex items-center gap-1 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition shadow-md"
                    }, 'Resume â†’')
                )
            );
        };

        const LoadingSpinner = ({ isDark }) => {
            return React.createElement('div', {
                className: "flex flex-col items-center justify-center min-h-[60vh] gap-4"
            },
                React.createElement('div', {
                    className: `w-16 h-16 border-4 border-t-indigo-600 border-r-transparent border-b-indigo-600 border-l-transparent rounded-full animate-spin`
                }),
                React.createElement('p', {
                    className: `${isDark ? 'text-gray-400' : 'text-gray-600'} font-medium`
                }, "Loading stories...")
            );
        };

        const LibraryView = ({
            books, readingStats, bookmarks, likes,
            onRead, onToggleBookmark, onLike,
            setShowAddBook, setShowBookmarks, isDark,
            lastReadPosition, onResumeReading,
            isLoading
        }) => {
            const lastReadBook = books.find(b => b.id === lastReadPosition.bookId);
            const shouldShowContinueReading = lastReadBook && lastReadPosition.progress > 5 && lastReadPosition.progress < 95;

            // Simple search/filter state (for Library View logic)
            const [searchTerm, setSearchTerm] = useState('');
            const [filterCategory, setFilterCategory] = useState('All');
            const categories = useMemo(() => ['All', ...new Set(books.map(b => b.category))], [books]);

            const filteredBooks = useMemo(() => {
                let filtered = books;

                if (filterCategory !== 'All') {
                    filtered = filtered.filter(book => book.category === filterCategory);
                }

                if (searchTerm) {
                    const lowerSearchTerm = searchTerm.toLowerCase();
                    filtered = filtered.filter(book => 
                        book.title.toLowerCase().includes(lowerSearchTerm) ||
                        book.author.toLowerCase().includes(lowerSearchTerm) ||
                        book.description.toLowerCase().includes(lowerSearchTerm)
                    );
                }
                return filtered;
            }, [books, filterCategory, searchTerm]);

            if (isLoading) {
                return React.createElement('div', { className: "container mx-auto px-4 py-8 max-w-7xl animate-fade-in pb-32" },
                    React.createElement(LoadingSpinner, { isDark: isDark })
                );
            }

            return React.createElement('div', { className: "container mx-auto px-4 py-8 max-w-7xl animate-fade-in pb-32" },
                // FIX APPLIED: Completed the React.createElement call here which was incomplete
                React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4" },
                    React.createElement('h1', { className: `text-4xl font-extrabold ${isDark ? 'text-white' : 'text-gray-900'}` }, "The MythMeHalfway Library"),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('button', {
                            onClick: setShowBookmarks,
                            className: `px-4 py-2 text-sm font-medium rounded-lg transition shadow-md ${isDark ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-white text-yellow-600 hover:bg-gray-50'} flex items-center gap-1`
                        }, 'Bookmarks ðŸ”–'),
                        React.createElement('button', {
                            onClick: setShowAddBook,
                            className: "px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition shadow-md flex items-center gap-1"
                        }, 'Add Story +')
                    )
                ),

                shouldShowContinueReading && React.createElement(ContinueReadingCard, {
                    book: lastReadBook,
                    progress: lastReadPosition.progress,
                    onResume: () => onResumeReading(lastReadBook),
                    isDark: isDark
                }),
                
                // Search and Filter controls
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" },
                    React.createElement('input', {
                        type: "text",
                        placeholder: "Search titles or authors...",
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: `p-3 rounded-lg border focus:ring-indigo-500 focus:border-indigo-500 transition ${isDark ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'}`
                    }),
                    React.createElement('select', {
                        value: filterCategory,
                        onChange: (e) => setFilterCategory(e.target.value),
                        className: `p-3 rounded-lg border focus:ring-indigo-500 focus:border-indigo-500 transition appearance-none ${isDark ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`
                    },
                        categories.map(category => React.createElement('option', { key: category, value: category }, category))
                    ),
                    React.createElement('div', { className: `p-3 rounded-lg flex items-center justify-center text-sm font-medium ${isDark ? 'bg-gray-700 text-gray-300' : 'bg-white text-gray-500'}` },
                        `${filteredBooks.length} Story${filteredBooks.length !== 1 ? 's' : ''} Found`
                    )
                ),

                // Book Grid
                React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" },
                    filteredBooks.map(book => React.createElement(BookCard, {
                        key: book.id,
                        book: book,
                        onRead: onRead,
                        isBookmarked: bookmarks.includes(book.id),
                        onToggleBookmark: onToggleBookmark,
                        onLike: onLike,
                        likes: likes,
                        isDark: isDark
                    }))
                ),
                
                filteredBooks.length === 0 && React.createElement('div', { className: "text-center py-20" },
                    React.createElement('p', { className: `text-xl font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}` }, "No stories match your search criteria.")
                )
            );
        };

        const BookmarksView = ({ bookmarks, books, onRead, onToggleBookmark, onLike, likes, isDark }) => {
            const bookmarkedStories = books.filter(book => bookmarks.includes(book.id));

            return React.createElement('div', { className: "container mx-auto px-4 py-8 max-w-7xl animate-fade-in pb-32" },
                React.createElement('h1', { className: `text-4xl font-extrabold mb-8 ${isDark ? 'text-white' : 'text-gray-900'}` }, "Your Bookmarks ðŸ”–"),
                
                bookmarkedStories.length > 0 ? (
                    React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" },
                        bookmarkedStories.map(book => React.createElement(BookCard, {
                            key: book.id,
                            book: book,
                            onRead: onRead,
                            isBookmarked: true,
                            onToggleBookmark: onToggleBookmark,
                            onLike: onLike,
                            likes: likes,
                            isDark: isDark
                        }))
                    )
                ) : (
                    React.createElement('div', { className: "text-center py-20" },
                        React.createElement('p', { className: `text-xl font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}` }, "You haven't bookmarked any stories yet!"),
                        React.createElement('p', { className: `text-sm mt-2 ${isDark ? 'text-gray-500' : 'text-gray-400'}` }, "Find a story you love and hit the bookmark icon.")
                    )
                )
            );
        };

        const AddBookView = ({ isDark, onNotification }) => {
            // This is a placeholder/mockup for adding a book since you don't have a backend UI for it.
            // In a real application, this would contain form inputs and API calls.
            
            const handleAdd = (e) => {
                e.preventDefault();
                // Mock success message
                onNotification("Story submitted for review!", "success");
            };

            return React.createElement('div', { className: "container mx-auto px-4 py-8 max-w-2xl animate-fade-in pb-32" },
                React.createElement('h1', { className: `text-4xl font-extrabold mb-8 ${isDark ? 'text-white' : 'text-gray-900'}` }, "Submit a New Story"),
                React.createElement('p', { className: `mb-6 ${isDark ? 'text-gray-400' : 'text-gray-600'}` }, "Want to share a tale? Submit your story details below. Note: This form is currently a mockup and will not save data permanently."),
                
                React.createElement('form', { 
                    className: `${isDark ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'} p-8 rounded-xl shadow-lg border`,
                    onSubmit: handleAdd
                },
                    React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { className: `block text-sm font-medium mb-1 ${isDark ? 'text-gray-300' : 'text-gray-700'}` }, "Title"),
                        React.createElement('input', { type: "text", required: true, className: `w-full p-3 border rounded-lg ${isDark ? 'bg-gray-900 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}` })
                    ),
                    React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { className: `block text-sm font-medium mb-1 ${isDark ? 'text-gray-300' : 'text-gray-700'}` }, "Author"),
                        React.createElement('input', { type: "text", required: true, className: `w-full p-3 border rounded-lg ${isDark ? 'bg-gray-900 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}` })
                    ),
                    React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { className: `block text-sm font-medium mb-1 ${isDark ? 'text-gray-300' : 'text-gray-700'}` }, "Story Content (Markdown)"),
                        React.createElement('textarea', { rows: 10, required: true, className: `w-full p-3 border rounded-lg font-mono text-sm ${isDark ? 'bg-gray-900 border-gray-600 text-white' : 'bg-gray-50 border-gray-300'}` })
                    ),
                    React.createElement('button', {
                        type: "submit",
                        className: "w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition"
                    }, "Submit Story")
                )
            );
        };

        const Footer = ({ isDark }) => {
            return React.createElement('footer', {
                className: `fixed bottom-0 left-0 right-0 p-4 border-t shadow-inner z-40 ${isDark ? 'bg-gray-900 border-gray-800 text-gray-400' : 'bg-white border-gray-200 text-gray-600'}`
            },
                React.createElement('div', { className: "container mx-auto max-w-7xl flex justify-between items-center text-xs" },
                    React.createElement('span', null, 'MythMeHalfway Â© 2024'),
                    React.createElement('span', null, 'Made with React and Tailwind CSS')
                )
            );
        };

        const NavBar = ({ onViewChange, currentView, isDark, toggleDarkMode }) => {
            const views = [
                { id: 'library', name: 'Library', icon: 'BookOpen' },
                { id: 'bookmarks', name: 'Bookmarks', icon: 'Bookmark' },
                { id: 'add', name: 'Submit', icon: 'Upload' },
            ];
            
            const Link = ({ viewId, name, iconName }) => {
                const isActive = currentView === viewId;
                const activeClasses = 'text-indigo-600 border-indigo-600';
                const inactiveClasses = isDark ? 'text-gray-400 border-transparent hover:text-white' : 'text-gray-500 border-transparent hover:text-gray-900';

                return React.createElement('button', {
                    onClick: () => onViewChange(viewId),
                    className: `flex flex-col items-center p-2 border-b-2 transition duration-300 ${isActive ? activeClasses : inactiveClasses}`
                },
                    React.createElement(IconPlaceholder, { name: iconName, size: 20, color: isActive ? '#4f46e5' : (isDark ? '#9ca3af' : 'currentColor') }),
                    React.createElement('span', { className: "mt-1 text-xs font-medium hidden sm:inline" }, name)
                );
            };

            return React.createElement('header', {
                className: `sticky top-0 z-50 shadow-md ${isDark ? 'bg-gray-800 border-b border-gray-700' : 'bg-white border-b border-gray-200'}`
            },
                React.createElement('div', { className: "container mx-auto max-w-7xl px-4 flex justify-between items-center h-16" },
                    React.createElement('div', {
                        className: `text-xl font-extrabold cursor-pointer ${isDark ? 'text-indigo-400' : 'text-indigo-600'}`
                    }, 'MythMeHalfway'),

                    React.createElement('nav', { className: "flex items-center space-x-6" },
                        views.map(view => React.createElement(Link, {
                            key: view.id,
                            viewId: view.id,
                            name: view.name,
                            iconName: view.icon
                        })),
                        React.createElement('button', {
                            onClick: toggleDarkMode,
                            className: `p-2 rounded-full transition ${isDark ? 'text-yellow-300 hover:bg-gray-700' : 'text-gray-800 hover:bg-gray-100'}`
                        }, isDark ? 'â˜€ï¸' : 'ðŸŒ™')
                    )
                )
            );
        };


        // --- Main App Component ---
        const App = () => {
            const [stories, setStories] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentView, setCurrentView] = useState('library'); // 'library', 'bookmarks', 'add'
            const [activeBook, setActiveBook] = useState(null);
            const [bookmarks, setBookmarks] = useState(JSON.parse(localStorage.getItem('bookmarks') || '[]'));
            const [likes, setLikes] = useState(JSON.parse(localStorage.getItem('likes') || '{}'));
            const [activeSound, setActiveSound] = useState(null);
            const [notification, setNotification] = useState(null);
            const [isDark, setIsDark] = useState(JSON.parse(localStorage.getItem('isDark') || 'false'));
            // { bookId: '1', progress: 50, position: 1200 }
            const [lastReadPosition, setLastReadPosition] = useState(JSON.parse(localStorage.getItem('lastReadPosition') || '{}'));

            useEffect(() => {
                document.body.className = isDark ? 'bg-gray-900 transition-colors' : 'bg-gray-100 transition-colors';
            }, [isDark]);
            
            useEffect(() => {
                fetchStoriesFromAPI()
                    .then(data => {
                        setStories(data);
                        setIsLoading(false);
                    })
                    .catch(() => {
                        console.log("Falling back to dummy data...");
                        setStories(getFallbackStories());
                        setIsLoading(false);
                        handleNotification('Could not fetch external stories. Using local dummy data.', 'error');
                    });
            }, []);

            useEffect(() => {
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
            }, [bookmarks]);

            useEffect(() => {
                localStorage.setItem('likes', JSON.stringify(likes));
            }, [likes]);

            useEffect(() => {
                localStorage.setItem('isDark', JSON.stringify(isDark));
            }, [isDark]);

            useEffect(() => {
                localStorage.setItem('lastReadPosition', JSON.stringify(lastReadPosition));
            }, [lastReadPosition]);

            const handleNotification = (message, type = 'info') => {
                setNotification({ message, type });
            };

            const handleToggleBookmark = (bookId) => {
                setBookmarks(prev => {
                    if (prev.includes(bookId)) {
                        handleNotification('Bookmark removed', 'info');
                        return prev.filter(id => id !== bookId);
                    } else {
                        handleNotification('Story bookmarked!', 'success');
                        return [...prev, bookId];
                    }
                });
            };

            const handleLike = (bookId) => {
                setLikes(prev => {
                    const currentLikes = prev[bookId] !== undefined ? prev[bookId] : stories.find(s => s.id === bookId)?.likes || 0;
                    if (prev.hasOwnProperty(bookId)) {
                        // Unlike
                        handleNotification('Unliked', 'info');
                        const newLikes = { ...prev };
                        delete newLikes[bookId]; // Use original value from stories instead
                        return newLikes;
                    } else {
                        // Like
                        handleNotification('Liked!', 'success');
                        return { ...prev, [bookId]: currentLikes + 1 };
                    }
                });
            };

            const handleToggleSound = (sound) => {
                if (activeSound?.id === sound?.id) {
                    setActiveSound(null);
                    handleNotification('Background audio stopped', 'info');
                } else if (sound) {
                    setActiveSound(sound);
                    handleNotification(`Playing: ${sound.name}`, 'success');
                } else {
                    setActiveSound(null);
                    handleNotification('Background audio stopped', 'info');
                }
            };
            
            const handleRead = (book) => {
                setActiveBook(book);
            };

            const handleResumeReading = (book) => {
                setActiveBook(book);
            };

            const handleUpdateProgress = (bookId, progress, position) => {
                setLastReadPosition({ bookId, progress, position });
            };

            const handleViewChange = (viewId) => {
                setCurrentView(viewId);
            };

            const toggleDarkMode = () => {
                setIsDark(prev => !prev);
            };

            const renderView = () => {
                switch (currentView) {
                    case 'bookmarks':
                        return React.createElement(BookmarksView, {
                            bookmarks, books: stories, onRead: handleRead, onToggleBookmark: handleToggleBookmark, onLike: handleLike, likes, isDark
                        });
                    case 'add':
                        return React.createElement(AddBookView, {
                            isDark, onNotification: handleNotification
                        });
                    case 'library':
                    default:
                        return React.createElement(LibraryView, {
                            books: stories,
                            bookmarks,
                            likes,
                            onRead: handleRead,
                            onToggleBookmark: handleToggleBookmark,
                            onLike: handleLike,
                            setShowAddBook: () => handleViewChange('add'),
                            setShowBookmarks: () => handleViewChange('bookmarks'),
                            isDark: isDark,
                            lastReadPosition: lastReadPosition,
                            onResumeReading: handleResumeReading,
                            isLoading
                        });
                }
            };

            return React.createElement(React.Fragment, null,
                React.createElement(NavBar, { onViewChange: handleViewChange, currentView, isDark, toggleDarkMode }),
                
                React.createElement('main', null,
                    renderView()
                ),
                
                React.createElement(SoundWidget, { activeSound, onToggleSound: handleToggleSound, isDark }),
                
                notification && React.createElement(Notification, {
                    message: notification.message,
                    type: notification.type,
                    onClose: () => setNotification(null)
                }),
                
                activeBook && React.createElement(ReaderModal, {
                    book: activeBook,
                    onClose: () => setActiveBook(null),
                    isDark: isDark,
                    onUpdateProgress: handleUpdateProgress,
                    lastReadPosition: lastReadPosition.bookId === activeBook.id ? lastReadPosition : {}
                }),
                
                React.createElement(Footer, { isDark })
            );
        };

        // Render the App
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
